// Generated by CoffeeScript 1.9.2

/**
 @license Sticky-kit v1.1.2 | WTFPL | Leaf Corcoran 2015 | http://leafo.net
 */

(function() {
    var $, win;

    $ = this.jQuery || window.jQuery;

    win = $(window);

    $.fn.stick_in_parent = function(opts) {
        var doc, elm, enable_bottoming, fn, i, inner_scrolling, len, manual_spacer, offset_top, parent_selector, recalc_every, sticky_class;
        if (opts == null) {
            opts = {};
        }
        sticky_class = opts.sticky_class, inner_scrolling = opts.inner_scrolling, recalc_every = opts.recalc_every, parent_selector = opts.parent, offset_top = opts.offset_top, manual_spacer = opts.spacer, enable_bottoming = opts.bottoming;
        if (offset_top == null) {
            offset_top = 0;
        }
        if (parent_selector == null) {
            parent_selector = void 0;
        }
        if (inner_scrolling == null) {
            inner_scrolling = true;
        }
        if (sticky_class == null) {
            sticky_class = "is_stuck";
        }
        doc = $(document);
        if (enable_bottoming == null) {
            enable_bottoming = true;
        }
        fn = function(elm, padding_bottom, parent_top, parent_height, top, height, el_float, detached) {
            var bottomed, detach, fixed, last_pos, last_scroll_height, offset, parent, recalc, recalc_and_tick, recalc_counter, spacer, tick;
            if (elm.data("sticky_kit")) {
                return;
            }
            elm.data("sticky_kit", true);
            last_scroll_height = doc.height();
            parent = elm.parent();
            if (parent_selector != null) {
                parent = parent.closest(parent_selector);
            }
            if (!parent.length) {
                throw "failed to find stick parent";
            }
            fixed = false;
            bottomed = false;
            spacer = manual_spacer != null ? manual_spacer && elm.closest(manual_spacer) : $("<div />");
            if (spacer) {
                spacer.css('position', elm.css('position'));
            }
            recalc = function() {
                var border_top, padding_top, restore;
                if (detached) {
                    return;
                }
                last_scroll_height = doc.height();
                border_top = parseInt(parent.css("border-top-width"), 10);
                padding_top = parseInt(parent.css("padding-top"), 10);
                padding_bottom = parseInt(parent.css("padding-bottom"), 10);
                parent_top = parent.offset().top + border_top + padding_top;
                parent_height = parent.height();
                if (fixed) {
                    fixed = false;
                    bottomed = false;
                    if (manual_spacer == null) {
                        elm.insertAfter(spacer);
                        spacer.detach();
                    }
                    elm.css({
                        position: "",
                        top: "",
                        width: "",
                        bottom: ""
                    }).removeClass(sticky_class);
                    restore = true;
                }
                top = elm.offset().top - (parseInt(elm.css("margin-top"), 10) || 0) - offset_top;
                height = elm.outerHeight(true);
                el_float = elm.css("float");
                if (spacer) {
                    spacer.css({
                        width: elm.outerWidth(true),
                        height: height,
                        display: elm.css("display"),
                        "vertical-align": elm.css("vertical-align"),
                        "float": el_float
                    });
                }
                if (restore) {
                    return tick();
                }
            };
            recalc();
            if (height === parent_height) {
                return;
            }
            last_pos = void 0;
            offset = offset_top;
            recalc_counter = recalc_every;
            tick = function() {
                var css, delta, recalced, scroll, will_bottom, win_height;
                if (detached) {
                    return;
                }
                recalced = false;
                if (recalc_counter != null) {
                    recalc_counter -= 1;
                    if (recalc_counter <= 0) {
                        recalc_counter = recalc_every;
                        recalc();
                        recalced = true;
                    }
                }
                if (!recalced && doc.height() !== last_scroll_height) {
                    recalc();
                    recalced = true;
                }
                scroll = win.scrollTop();
                if (last_pos != null) {
                    delta = scroll - last_pos;
                }
                last_pos = scroll;
                if (fixed) {
                    if (enable_bottoming) {
                        will_bottom = scroll + height + offset > parent_height + parent_top;
                        if (bottomed && !will_bottom) {
                            bottomed = false;
                            elm.css({
                                position: "fixed",
                                bottom: "",
                                top: offset
                            }).trigger("sticky_kit:unbottom");
                        }
                    }
                    if (scroll < top) {
                        fixed = false;
                        offset = offset_top;
                        if (manual_spacer == null) {
                            if (el_float === "left" || el_float === "right") {
                                elm.insertAfter(spacer);
                            }
                            spacer.detach();
                        }
                        css = {
                            position: "",
                            width: "",
                            top: ""
                        };
                        elm.css(css).removeClass(sticky_class).trigger("sticky_kit:unstick");
                    }
                    if (inner_scrolling) {
                        win_height = win.height();
                        if (height + offset_top > win_height) {
                            if (!bottomed) {
                                offset -= delta;
                                offset = Math.max(win_height - height, offset);
                                offset = Math.min(offset_top, offset);
                                if (fixed) {
                                    elm.css({
                                        top: offset + "px"
                                    });
                                }
                            }
                        }
                    }
                } else {
                    if (scroll > top) {
                        fixed = true;
                        css = {
                            position: "fixed",
                            top: offset
                        };
                        css.width = elm.css("box-sizing") === "border-box" ? elm.outerWidth() + "px" : elm.width() + "px";
                        elm.css(css).addClass(sticky_class);
                        if (manual_spacer == null) {
                            elm.after(spacer);
                            if (el_float === "left" || el_float === "right") {
                                spacer.append(elm);
                            }
                        }
                        elm.trigger("sticky_kit:stick");
                    }
                }
                if (fixed && enable_bottoming) {
                    if (will_bottom == null) {
                        will_bottom = scroll + height + offset > parent_height + parent_top;
                    }
                    if (!bottomed && will_bottom) {
                        bottomed = true;
                        if (parent.css("position") === "static") {
                            parent.css({
                                position: "relative"
                            });
                        }
                        return elm.css({
                            position: "absolute",
                            bottom: padding_bottom,
                            top: "auto"
                        }).trigger("sticky_kit:bottom");
                    }
                }
            };
            recalc_and_tick = function() {
                recalc();
                return tick();
            };
            detach = function() {
                detached = true;
                win.off("touchmove", tick);
                win.off("scroll", tick);
                win.off("resize", recalc_and_tick);
                $(document.body).off("sticky_kit:recalc", recalc_and_tick);
                elm.off("sticky_kit:detach", detach);
                elm.removeData("sticky_kit");
                elm.css({
                    position: "",
                    bottom: "",
                    top: "",
                    width: ""
                });
                parent.position("position", "");
                if (fixed) {
                    if (manual_spacer == null) {
                        if (el_float === "left" || el_float === "right") {
                            elm.insertAfter(spacer);
                        }
                        spacer.remove();
                    }
                    return elm.removeClass(sticky_class);
                }
            };
            win.on("touchmove", tick);
            win.on("scroll", tick);
            win.on("resize", recalc_and_tick);
            $(document.body).on("sticky_kit:recalc", recalc_and_tick);
            elm.on("sticky_kit:detach", detach);
            return setTimeout(tick, 0);
        };
        for (i = 0, len = this.length; i < len; i++) {
            elm = this[i];
            fn($(elm));
        }
        return this;
    };

}).call(this);
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJzdGlja3kta2l0LmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS45LjJcblxuLyoqXG4gQGxpY2Vuc2UgU3RpY2t5LWtpdCB2MS4xLjIgfCBXVEZQTCB8IExlYWYgQ29yY29yYW4gMjAxNSB8IGh0dHA6Ly9sZWFmby5uZXRcbiAqL1xuXG4oZnVuY3Rpb24oKSB7XG4gICAgdmFyICQsIHdpbjtcblxuICAgICQgPSB0aGlzLmpRdWVyeSB8fCB3aW5kb3cualF1ZXJ5O1xuXG4gICAgd2luID0gJCh3aW5kb3cpO1xuXG4gICAgJC5mbi5zdGlja19pbl9wYXJlbnQgPSBmdW5jdGlvbihvcHRzKSB7XG4gICAgICAgIHZhciBkb2MsIGVsbSwgZW5hYmxlX2JvdHRvbWluZywgZm4sIGksIGlubmVyX3Njcm9sbGluZywgbGVuLCBtYW51YWxfc3BhY2VyLCBvZmZzZXRfdG9wLCBwYXJlbnRfc2VsZWN0b3IsIHJlY2FsY19ldmVyeSwgc3RpY2t5X2NsYXNzO1xuICAgICAgICBpZiAob3B0cyA9PSBudWxsKSB7XG4gICAgICAgICAgICBvcHRzID0ge307XG4gICAgICAgIH1cbiAgICAgICAgc3RpY2t5X2NsYXNzID0gb3B0cy5zdGlja3lfY2xhc3MsIGlubmVyX3Njcm9sbGluZyA9IG9wdHMuaW5uZXJfc2Nyb2xsaW5nLCByZWNhbGNfZXZlcnkgPSBvcHRzLnJlY2FsY19ldmVyeSwgcGFyZW50X3NlbGVjdG9yID0gb3B0cy5wYXJlbnQsIG9mZnNldF90b3AgPSBvcHRzLm9mZnNldF90b3AsIG1hbnVhbF9zcGFjZXIgPSBvcHRzLnNwYWNlciwgZW5hYmxlX2JvdHRvbWluZyA9IG9wdHMuYm90dG9taW5nO1xuICAgICAgICBpZiAob2Zmc2V0X3RvcCA9PSBudWxsKSB7XG4gICAgICAgICAgICBvZmZzZXRfdG9wID0gMDtcbiAgICAgICAgfVxuICAgICAgICBpZiAocGFyZW50X3NlbGVjdG9yID09IG51bGwpIHtcbiAgICAgICAgICAgIHBhcmVudF9zZWxlY3RvciA9IHZvaWQgMDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaW5uZXJfc2Nyb2xsaW5nID09IG51bGwpIHtcbiAgICAgICAgICAgIGlubmVyX3Njcm9sbGluZyA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHN0aWNreV9jbGFzcyA9PSBudWxsKSB7XG4gICAgICAgICAgICBzdGlja3lfY2xhc3MgPSBcImlzX3N0dWNrXCI7XG4gICAgICAgIH1cbiAgICAgICAgZG9jID0gJChkb2N1bWVudCk7XG4gICAgICAgIGlmIChlbmFibGVfYm90dG9taW5nID09IG51bGwpIHtcbiAgICAgICAgICAgIGVuYWJsZV9ib3R0b21pbmcgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGZuID0gZnVuY3Rpb24oZWxtLCBwYWRkaW5nX2JvdHRvbSwgcGFyZW50X3RvcCwgcGFyZW50X2hlaWdodCwgdG9wLCBoZWlnaHQsIGVsX2Zsb2F0LCBkZXRhY2hlZCkge1xuICAgICAgICAgICAgdmFyIGJvdHRvbWVkLCBkZXRhY2gsIGZpeGVkLCBsYXN0X3BvcywgbGFzdF9zY3JvbGxfaGVpZ2h0LCBvZmZzZXQsIHBhcmVudCwgcmVjYWxjLCByZWNhbGNfYW5kX3RpY2ssIHJlY2FsY19jb3VudGVyLCBzcGFjZXIsIHRpY2s7XG4gICAgICAgICAgICBpZiAoZWxtLmRhdGEoXCJzdGlja3lfa2l0XCIpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxtLmRhdGEoXCJzdGlja3lfa2l0XCIsIHRydWUpO1xuICAgICAgICAgICAgbGFzdF9zY3JvbGxfaGVpZ2h0ID0gZG9jLmhlaWdodCgpO1xuICAgICAgICAgICAgcGFyZW50ID0gZWxtLnBhcmVudCgpO1xuICAgICAgICAgICAgaWYgKHBhcmVudF9zZWxlY3RvciAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LmNsb3Nlc3QocGFyZW50X3NlbGVjdG9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghcGFyZW50Lmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHRocm93IFwiZmFpbGVkIHRvIGZpbmQgc3RpY2sgcGFyZW50XCI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmaXhlZCA9IGZhbHNlO1xuICAgICAgICAgICAgYm90dG9tZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHNwYWNlciA9IG1hbnVhbF9zcGFjZXIgIT0gbnVsbCA/IG1hbnVhbF9zcGFjZXIgJiYgZWxtLmNsb3Nlc3QobWFudWFsX3NwYWNlcikgOiAkKFwiPGRpdiAvPlwiKTtcbiAgICAgICAgICAgIGlmIChzcGFjZXIpIHtcbiAgICAgICAgICAgICAgICBzcGFjZXIuY3NzKCdwb3NpdGlvbicsIGVsbS5jc3MoJ3Bvc2l0aW9uJykpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVjYWxjID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgdmFyIGJvcmRlcl90b3AsIHBhZGRpbmdfdG9wLCByZXN0b3JlO1xuICAgICAgICAgICAgICAgIGlmIChkZXRhY2hlZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxhc3Rfc2Nyb2xsX2hlaWdodCA9IGRvYy5oZWlnaHQoKTtcbiAgICAgICAgICAgICAgICBib3JkZXJfdG9wID0gcGFyc2VJbnQocGFyZW50LmNzcyhcImJvcmRlci10b3Atd2lkdGhcIiksIDEwKTtcbiAgICAgICAgICAgICAgICBwYWRkaW5nX3RvcCA9IHBhcnNlSW50KHBhcmVudC5jc3MoXCJwYWRkaW5nLXRvcFwiKSwgMTApO1xuICAgICAgICAgICAgICAgIHBhZGRpbmdfYm90dG9tID0gcGFyc2VJbnQocGFyZW50LmNzcyhcInBhZGRpbmctYm90dG9tXCIpLCAxMCk7XG4gICAgICAgICAgICAgICAgcGFyZW50X3RvcCA9IHBhcmVudC5vZmZzZXQoKS50b3AgKyBib3JkZXJfdG9wICsgcGFkZGluZ190b3A7XG4gICAgICAgICAgICAgICAgcGFyZW50X2hlaWdodCA9IHBhcmVudC5oZWlnaHQoKTtcbiAgICAgICAgICAgICAgICBpZiAoZml4ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgZml4ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgYm90dG9tZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1hbnVhbF9zcGFjZXIgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxtLmluc2VydEFmdGVyKHNwYWNlcik7XG4gICAgICAgICAgICAgICAgICAgICAgICBzcGFjZXIuZGV0YWNoKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxtLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogXCJcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogXCJcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiBcIlwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgYm90dG9tOiBcIlwiXG4gICAgICAgICAgICAgICAgICAgIH0pLnJlbW92ZUNsYXNzKHN0aWNreV9jbGFzcyk7XG4gICAgICAgICAgICAgICAgICAgIHJlc3RvcmUgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0b3AgPSBlbG0ub2Zmc2V0KCkudG9wIC0gKHBhcnNlSW50KGVsbS5jc3MoXCJtYXJnaW4tdG9wXCIpLCAxMCkgfHwgMCkgLSBvZmZzZXRfdG9wO1xuICAgICAgICAgICAgICAgIGhlaWdodCA9IGVsbS5vdXRlckhlaWdodCh0cnVlKTtcbiAgICAgICAgICAgICAgICBlbF9mbG9hdCA9IGVsbS5jc3MoXCJmbG9hdFwiKTtcbiAgICAgICAgICAgICAgICBpZiAoc3BhY2VyKSB7XG4gICAgICAgICAgICAgICAgICAgIHNwYWNlci5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IGVsbS5vdXRlcldpZHRoKHRydWUpLFxuICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHQsXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiBlbG0uY3NzKFwiZGlzcGxheVwiKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwidmVydGljYWwtYWxpZ25cIjogZWxtLmNzcyhcInZlcnRpY2FsLWFsaWduXCIpLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJmbG9hdFwiOiBlbF9mbG9hdFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHJlc3RvcmUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRpY2soKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcmVjYWxjKCk7XG4gICAgICAgICAgICBpZiAoaGVpZ2h0ID09PSBwYXJlbnRfaGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGFzdF9wb3MgPSB2b2lkIDA7XG4gICAgICAgICAgICBvZmZzZXQgPSBvZmZzZXRfdG9wO1xuICAgICAgICAgICAgcmVjYWxjX2NvdW50ZXIgPSByZWNhbGNfZXZlcnk7XG4gICAgICAgICAgICB0aWNrID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgdmFyIGNzcywgZGVsdGEsIHJlY2FsY2VkLCBzY3JvbGwsIHdpbGxfYm90dG9tLCB3aW5faGVpZ2h0O1xuICAgICAgICAgICAgICAgIGlmIChkZXRhY2hlZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJlY2FsY2VkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKHJlY2FsY19jb3VudGVyICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVjYWxjX2NvdW50ZXIgLT0gMTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlY2FsY19jb3VudGVyIDw9IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlY2FsY19jb3VudGVyID0gcmVjYWxjX2V2ZXJ5O1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVjYWxjKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWNhbGNlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFyZWNhbGNlZCAmJiBkb2MuaGVpZ2h0KCkgIT09IGxhc3Rfc2Nyb2xsX2hlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICByZWNhbGMoKTtcbiAgICAgICAgICAgICAgICAgICAgcmVjYWxjZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzY3JvbGwgPSB3aW4uc2Nyb2xsVG9wKCk7XG4gICAgICAgICAgICAgICAgaWYgKGxhc3RfcG9zICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgZGVsdGEgPSBzY3JvbGwgLSBsYXN0X3BvcztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGFzdF9wb3MgPSBzY3JvbGw7XG4gICAgICAgICAgICAgICAgaWYgKGZpeGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlbmFibGVfYm90dG9taW5nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aWxsX2JvdHRvbSA9IHNjcm9sbCArIGhlaWdodCArIG9mZnNldCA+IHBhcmVudF9oZWlnaHQgKyBwYXJlbnRfdG9wO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJvdHRvbWVkICYmICF3aWxsX2JvdHRvbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvdHRvbWVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxtLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBcImZpeGVkXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvdHRvbTogXCJcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiBvZmZzZXRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS50cmlnZ2VyKFwic3RpY2t5X2tpdDp1bmJvdHRvbVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoc2Nyb2xsIDwgdG9wKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmaXhlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ID0gb2Zmc2V0X3RvcDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYW51YWxfc3BhY2VyID09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxfZmxvYXQgPT09IFwibGVmdFwiIHx8IGVsX2Zsb2F0ID09PSBcInJpZ2h0XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxtLmluc2VydEFmdGVyKHNwYWNlcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwYWNlci5kZXRhY2goKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGNzcyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogXCJcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogXCJcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3A6IFwiXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICBlbG0uY3NzKGNzcykucmVtb3ZlQ2xhc3Moc3RpY2t5X2NsYXNzKS50cmlnZ2VyKFwic3RpY2t5X2tpdDp1bnN0aWNrXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbm5lcl9zY3JvbGxpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpbl9oZWlnaHQgPSB3aW4uaGVpZ2h0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGVpZ2h0ICsgb2Zmc2V0X3RvcCA+IHdpbl9oZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWJvdHRvbWVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldCAtPSBkZWx0YTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ID0gTWF0aC5tYXgod2luX2hlaWdodCAtIGhlaWdodCwgb2Zmc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ID0gTWF0aC5taW4ob2Zmc2V0X3RvcCwgb2Zmc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpeGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbG0uY3NzKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3A6IG9mZnNldCArIFwicHhcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2Nyb2xsID4gdG9wKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmaXhlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBjc3MgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IFwiZml4ZWRcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3A6IG9mZnNldFxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNzcy53aWR0aCA9IGVsbS5jc3MoXCJib3gtc2l6aW5nXCIpID09PSBcImJvcmRlci1ib3hcIiA/IGVsbS5vdXRlcldpZHRoKCkgKyBcInB4XCIgOiBlbG0ud2lkdGgoKSArIFwicHhcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsbS5jc3MoY3NzKS5hZGRDbGFzcyhzdGlja3lfY2xhc3MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hbnVhbF9zcGFjZXIgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsbS5hZnRlcihzcGFjZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbF9mbG9hdCA9PT0gXCJsZWZ0XCIgfHwgZWxfZmxvYXQgPT09IFwicmlnaHRcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGFjZXIuYXBwZW5kKGVsbSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxtLnRyaWdnZXIoXCJzdGlja3lfa2l0OnN0aWNrXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChmaXhlZCAmJiBlbmFibGVfYm90dG9taW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh3aWxsX2JvdHRvbSA9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aWxsX2JvdHRvbSA9IHNjcm9sbCArIGhlaWdodCArIG9mZnNldCA+IHBhcmVudF9oZWlnaHQgKyBwYXJlbnRfdG9wO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICghYm90dG9tZWQgJiYgd2lsbF9ib3R0b20pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvdHRvbWVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQuY3NzKFwicG9zaXRpb25cIikgPT09IFwic3RhdGljXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuY3NzKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IFwicmVsYXRpdmVcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsbS5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBcImFic29sdXRlXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYm90dG9tOiBwYWRkaW5nX2JvdHRvbSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3A6IFwiYXV0b1wiXG4gICAgICAgICAgICAgICAgICAgICAgICB9KS50cmlnZ2VyKFwic3RpY2t5X2tpdDpib3R0b21cIik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcmVjYWxjX2FuZF90aWNrID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgcmVjYWxjKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRpY2soKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBkZXRhY2ggPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBkZXRhY2hlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgd2luLm9mZihcInRvdWNobW92ZVwiLCB0aWNrKTtcbiAgICAgICAgICAgICAgICB3aW4ub2ZmKFwic2Nyb2xsXCIsIHRpY2spO1xuICAgICAgICAgICAgICAgIHdpbi5vZmYoXCJyZXNpemVcIiwgcmVjYWxjX2FuZF90aWNrKTtcbiAgICAgICAgICAgICAgICAkKGRvY3VtZW50LmJvZHkpLm9mZihcInN0aWNreV9raXQ6cmVjYWxjXCIsIHJlY2FsY19hbmRfdGljayk7XG4gICAgICAgICAgICAgICAgZWxtLm9mZihcInN0aWNreV9raXQ6ZGV0YWNoXCIsIGRldGFjaCk7XG4gICAgICAgICAgICAgICAgZWxtLnJlbW92ZURhdGEoXCJzdGlja3lfa2l0XCIpO1xuICAgICAgICAgICAgICAgIGVsbS5jc3Moe1xuICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogXCJcIixcbiAgICAgICAgICAgICAgICAgICAgYm90dG9tOiBcIlwiLFxuICAgICAgICAgICAgICAgICAgICB0b3A6IFwiXCIsXG4gICAgICAgICAgICAgICAgICAgIHdpZHRoOiBcIlwiXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcGFyZW50LnBvc2l0aW9uKFwicG9zaXRpb25cIiwgXCJcIik7XG4gICAgICAgICAgICAgICAgaWYgKGZpeGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtYW51YWxfc3BhY2VyID09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbF9mbG9hdCA9PT0gXCJsZWZ0XCIgfHwgZWxfZmxvYXQgPT09IFwicmlnaHRcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsbS5pbnNlcnRBZnRlcihzcGFjZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgc3BhY2VyLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBlbG0ucmVtb3ZlQ2xhc3Moc3RpY2t5X2NsYXNzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgd2luLm9uKFwidG91Y2htb3ZlXCIsIHRpY2spO1xuICAgICAgICAgICAgd2luLm9uKFwic2Nyb2xsXCIsIHRpY2spO1xuICAgICAgICAgICAgd2luLm9uKFwicmVzaXplXCIsIHJlY2FsY19hbmRfdGljayk7XG4gICAgICAgICAgICAkKGRvY3VtZW50LmJvZHkpLm9uKFwic3RpY2t5X2tpdDpyZWNhbGNcIiwgcmVjYWxjX2FuZF90aWNrKTtcbiAgICAgICAgICAgIGVsbS5vbihcInN0aWNreV9raXQ6ZGV0YWNoXCIsIGRldGFjaCk7XG4gICAgICAgICAgICByZXR1cm4gc2V0VGltZW91dCh0aWNrLCAwKTtcbiAgICAgICAgfTtcbiAgICAgICAgZm9yIChpID0gMCwgbGVuID0gdGhpcy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgICAgICAgZWxtID0gdGhpc1tpXTtcbiAgICAgICAgICAgIGZuKCQoZWxtKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfTtcblxufSkuY2FsbCh0aGlzKTsiXSwiZmlsZSI6InN0aWNreS1raXQuanMifQ==
